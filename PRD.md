# PRD: 다나와/지마켓 최저가 알림이 (크롤링 기반)

## 1. 개요

사용자가 등록한 상품(키워드 기반)을 다나와/지마켓에서 검색하여 **현재 최저가와 구매 링크**를 제공하고, 설정된 조건과 주기에 따라 **이메일 알림**을 발송하는 데스크톱 프로그램을 개발한다.  
공식 Open API 사용이 불가능하므로 웹 크롤링(HTML 파싱/헤드리스 브라우저)을 사용한다. 자동구매는 범위에서 제외한다.

---

## 2. 문제 정의

- 사용자는 원하는 물건의 최저가 변동을 매번 수동으로 확인하기 어렵다.
- 다나와/지마켓은 구매자 관점에서 활용 가능한 Open API가 사실상 없어 크롤링이 필요하다.
- 키워드 입력 기반 크롤링은 “오타/미존재 상품/오매칭” 리스크가 크므로, **등록 단계에서 검증(confirmation) 플로우**가 필요하다.
- 크롤링 요청이 과도하거나 일정한 패턴이면 사이트가 프로그램을 **악성봇으로 판단해 차단**할 가능성이 있어, **주기/빈도 제한과 재시도 정책**이 필요하다.

---

## 3. 목표 / 비목표

### 3.1 목표(Goals)

사용자가 추적 대상을 등록하면:
- 사이트별 최저가(표시가 기준)
- 구매 링크(판매 페이지 이동)
- 조회 시각
- (조건 충족 시) 이메일 알림 발송
또한:
- 키워드 입력 오류 및 오매칭을 방지하기 위한 “검색 결과 선택(2-step 등록)” 제공
- 사이트 차단 리스크를 낮추기 위한 주기 제한(최소 15분) 및 백오프 재시도 정책 적용

### 3.2 비목표(Non-goals)

- 자동 구매/결제/로그인 자동화
- 쿠폰·카드할인·배송비 포함 등 ‘실구매 최저가’ 완전 계산
- 대규모 가격 데이터 수집/재판매/장기 분석

---

## 4. 사용자 및 사용 시나리오

### 4.1 사용자
- 특정 PC 부품/전자제품을 목표가 이하에 구매하려는 사용자
- 가격을 자주 확인할 시간이 없어 알림이 필요한 사용자

### 4.2 대표 시나리오

1. 사용자가 키워드(예: “RTX 4070 Ti SUPER”) 입력
2. 프로그램이 다나와/지마켓에서 검색 결과 상위 N개를 표시
3. 사용자가 원하는 상품을 선택(번호 선택)
4. 프로그램이 선택된 상품을 일정 주기로 조회
5. 가격 조건/알림 주기 만족 시 이메일 알림 발송(최저가+링크) 

---

## 5. 기능 요구사항

## 5.1 GUI 입력 항목(필수)

- 제품 키워드 입력(텍스트)
- 크롤링 주기 선택(드롭다운, **최소 15분**)
- 알림 주기 선택(드롭다운, **최소 1시간 ~ 최대 1주**)
- 알림 발송용 이메일 주소 입력
- 사이트 선택: 다나와 / 지마켓 / 둘 다
- [버튼] “검색/후보 가져오기” / “추적 시작” / “중지” / “테스트 알림”

### 주기 UI 제공 가이드(고정 선택지)

- **크롤링 주기(최소 15분)**: `15분, 30분, 1시간, 2시간, 4시간, 8시간, 12시간, 24시간`
- **알림 주기(1시간~1주)**: `1시간, 3시간, 6시간, 12시간, 24시간, 3일, 7일`
- 사용자는 숫자를 자유입력하지 않고 **선택만** 가능하도록 제한(차단 리스크 완화 목적)

## 5.2 2-step 등록(오타/오매칭 방지) — 핵심

- [1단계] 키워드 입력 후 “검색/후보 가져오기”
- [2단계] 사이트별 검색 결과 상위 N개(5~10개) 리스트 표시  
    표시 항목:
    - 상품명
    - 대표가격(가능 시)
    - 판매처/쇼핑몰(가능 시)
    - 링크(미리보기 또는 “열기” 버튼)
- 사용자는 리스트에서 “내가 원하는 상품”을 선택 후 추적 시작  
    → 이후 추적 기준은 “선택된 상품 URL”을 우선으로 사용(안정성 증가)

## 5.3 가격 조회 및 최저가 산출

- 각 사이트에서 가격/상품명/구매 링크 추출
- 사이트별 결과를 공통 스키마로 정규화:
    - `site, title, price, product_url, fetched_at`
- “둘 다” 선택 시:
    - 사이트별 최저가를 각각 표시 + 전체 최저가도 함께 표시(단, 기준(배송비/쿠폰 미포함) 문구 표기)

## 5.4 알림 발송(이메일)

- 알림 내용(최소):
    - 상품명
    - 현재 최저가
    - 사이트(다나와/지마켓)
    - 구매 링크
    - 조회 시각
- 알림 트리거:
    - (MVP) “알림 주기마다 최신 최저가 요약 발송”
    - (확장) 목표가 이하/하락폭 이상일 때 즉시 알림 옵션 

## 5.5 상태 표시/로그(사용자용)

- GUI에 상태 표시:
    - “정상 조회 중”, “검색 결과 없음”, “재확인 필요”, “접속 차단 의심”
- 사용자에게 필요한 수준의 간단 로그:
    - 마지막 조회 시각, 마지막 가격, 마지막 알림 시각 

---

## 6. 예외/리스크 대응 정책

## 6.1 검색 결과 없음(오타/미존재)

- “검색 결과가 없습니다” 메시지 + 키워드 수정 가이드 제공
    - 예: 불필요 단어 제거, 띄어쓰기 변형, 모델명만 남기기
- 사용자가 링크를 직접 붙여넣는 “URL 등록 모드”(v1 옵션) 제공 가능

## 6.2 오매칭 방지(정합성 체크)

- 사용자가 선택한 상품이라도 추적 중 아래 상황이면 `재확인 필요`로 전환:
    - 상품명이 크게 달라짐(핵심 토큰 불일치)
    - 가격이 비정상 급변(예: ±30% 이상)
    - 페이지가 품절/차단/오류 페이지로 바뀜
- 재확인 필요 시:
    - 다시 후보 리스트를 보여주고 사용자 재선택 유도  

## 6.3 사이트 차단(악성봇 오인) 리스크 완화

- 크롤링 주기 최소 15분 강제
- 요청 패턴이 너무 일정하지 않도록 **약간의 랜덤 지연(지터) 추가**(예: 0~20초)
- 실패 시 즉시 연타하지 않고 “잠시 쉬었다가 재시도”(백오프)
- 차단 의심 시(응답 이상/리다이렉트/캡차/403 등):
    - 자동으로 조회 빈도를 낮추고 사용자에게 안내

---

## 7. 데이터 저장 정책(요구 반영)

- 가격 스냅샷을 대량/장기 저장하지 않는다.
- 단, 알림/운영을 위해 최소 상태는 로컬에 저장할 수 있음(권장):
    - 마지막 조회 가격, 마지막 알림 시각, 선택된 상품 URL, 사용자 설정값  
        → 단일 JSON 또는 SQLite 1파일(로컬) 수준

---

## 8. 성공 기준(DoD)

- 키워드로 후보 조회가 정상 동작하고, 사용자가 선택한 상품을 안정적으로 추적한다.
- 크롤링 주기/알림 주기가 UI 제한대로 적용된다(최소 15분/최소 1시간).
- 알림 이메일이 설정 주기마다 정상 발송된다.
- 검색 결과 없음/차단 의심/오매칭 의심 상황에서 사용자에게 명확히 안내한다.